//TODO:This autogenerated class includes the basics for a Registration
//Handler class. You will need to customize it to ensure it meets your needs and
//the data provided by the third party.

global class SpotifyLoginHandler implements Auth.RegistrationHandler{



global User createUser(Id portalId, Auth.UserData data){

        //We have a community id, so create a user with community access
        //TODO: Get an actual account
        Account a = [SELECT Id FROM account WHERE name='test'];
        Contact c = new Contact();
        c.accountId = a.Id;
        c.email = data.email;
        c.firstName = 'Spotify';
        c.lastName = 'Login User';
        insert(c);

        //TODO: Customize the username and profile. Also check that the username doesn't already exist and
        //possibly ensure there are enough org licenses to create a user. Must be 80 characters or less.
        User u = new User();
        Profile p = [SELECT Id FROM profile WHERE name='Customer Community Plus User'];
        u.username = data.username + '@spotifylogin.com';
        u.email = data.email;
        u.lastName = 'Spotify';
        u.firstName = 'Login User';
        String alias = data.username;
        //Alias must be 8 characters or less
        if(alias.length() > 8) {
            alias = alias.substring(0, 8);
        }
        u.alias = alias;
        u.languagelocalekey = UserInfo.getLocale();
        u.localesidkey = UserInfo.getLocale();
        u.emailEncodingKey = 'UTF-8';
        u.timeZoneSidKey = 'America/Los_Angeles';
        u.profileId = p.Id;
        u.contactId = c.Id;
        return u;
    
}

global void updateUser(Id userId, Id portalId, Auth.UserData data){
    portalId = '0DB5j000001ChBaGAK';

    user u = [select id, email from user where id=:userId];
    
    u.email = data.email;
    
    update(u);
    
}
}